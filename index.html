<html>
	<head>
		 <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<title>FITS image browser</title>
	</head>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>

<script src="imageMetadata.js"></script>

<script type="text/javascript">	
	// Global variables
	var allImages;
	var currentImages;
	tableFormat = "grid";
	currentDirection = "ascending";
	var previewCanvasVisible = false;
	var previewCanvas;
	var image;
	var previewIndex = 0;
	var width=0
	var height=0;
	
	// Call my start up method after the page has finished loading
	window.addEventListener("load", pageLoaded, false);
	

	document.onkeydown = function(e) {
		e = e?e:window.event;
		console.log(e.keyCode + " pressed");
		if ($("#filter").is(':focus')) {
			// Ignore keypress if the user is typing in the search box
			return;
		}
		switch(e.keyCode) {
			case 27: // 'esc' key
				$('#imagecanvas').css('visibility', 'hidden');
				previewCanvasVisible = false;
				break;
			case 80: // 'p' key
				console.log("toggle preview");
				if (previewCanvasVisible) {
					$('#imagecanvas').css('visibility', 'hidden');
					previewCanvasVisible = false;
					
				} else {
					$('#imagecanvas').css('visibility', 'visible');
					previewCanvasVisible = true;
					var image = new Image();
					image.src = currentImages[previewIndex].pngFilename;
					console.log("Loading", currentImages[previewIndex].sourceFilename);
					image.onload = function() {
						context.drawImage(image, 0, 0, width, height);
						};
				}
				break;
			case 39: // 'right' key
				if (!previewCanvasVisible) break;
				previewIndex++; 
				if (previewIndex==currentImages.length) previewIndex = 0;
				var image = new Image();
				image.src = currentImages[previewIndex].pngFilename;
				console.log("Loading", currentImages[previewIndex].sourceFilename);
				image.onload = function() {
					context.drawImage(image, 0, 0, width, height);
				};
				break;
			case 37: // 'right' key
				if (!previewCanvasVisible) break;
				previewIndex--; 
				if (previewIndex<0) previewIndex = currentImages.length -1;
				var image = new Image();
				image.src = currentImages[previewIndex].pngFilename;
				console.log("Loading", currentImages[previewIndex].sourceFilename);
				image.onload = function() {
					context.drawImage(image, 0, 0, width, height);
				};
				break;
			}
		}
	
		//		switch(e.keyCode) {
		//			case 38: //up arrow
		
	function updatePreviewImage(index) {
		var image = new Image();
		image.src = currentImages[index].pngFilename;
		console.log("Loading", currentImages[index].sourceFilename);
		image.onload = redrawCanvas();
	}
	
	function clearCanvas() {
			// Clear the canvas area
			context.fillStyle = "#aaaaaa";
			context.fillRect(0, 0, width, height);
			context.fillStyle = "#000000";	
		}
		
	function redrawCanvas() {
		console.log("Redrawing canvas...");
		console.log("image src", image.src);
		clearCanvas();
		context.drawImage(image, 0, 0);
	}
		
	function pageLoaded() {
		console.log(allImages);
		$("#numberimages").text(allImages.length);
		currentImages = allImages.slice(0);
		//imageMetadata.sort(function(a){return imageMetadata.sourceFilename;});
		// Check for any pre-saved configuration
		if (localStorage.searchString) {
			$("#filter").text(localStorage.searchString);
			filterImages();
		}
		if (localStorage.tableFormat) {
			tableFormat = localStorage.tableFormat;
		}
		if (localStorage.sortOrder) {
			sort(localStorage.sortOrder);
			console.log("retrieved sort order", localStorage.sortOrder);
		} else sort("ascending");
		
		makeImageTable(currentImages);
		previewCanvas = document.getElementById("imagecanvas");
		context = previewCanvas.getContext("2d");
		width = previewCanvas.width;
		height = previewCanvas.height;
	}
	
	function sort(direction) {
		console.log("Requested to sort:", direction);
		if (direction=="ascending") currentDirection = "ascending";
		if (direction=="descending") currentDirection = "descending";
		if (direction=="toggle") currentDirection = (currentDirection == "ascending") ? "descending" : "ascending";
		if (currentDirection=="ascending") currentImages.sort(function(a,b) {
		    var x = a.sourceFilename.toLowerCase();
		    var y = b.sourceFilename.toLowerCase();
		    return x < y ? -1 : x > y ? 1 : 0;
		});
		else currentImages.sort(function(a,b) {
		    var x = a.sourceFilename.toLowerCase();
		    var y = b.sourceFilename.toLowerCase();
		    return x < y ? 1 : x > y ? -1 : 0;
		});
		
		console.log("Sorted: ", currentDirection);
		makeImageTable(currentImages);
		if (currentDirection == "ascending") {
			$("#sorticon").removeClass("glyphicon-sort-by-alphabet");
			$("#sorticon").addClass("glyphicon-sort-by-alphabet-alt");
		} else {
			$("#sorticon").addClass("glyphicon-sort-by-alphabet");
			$("#sorticon").removeClass("glyphicon-sort-by-alphabet-alt");
		}
		localStorage.sortOrder = currentDirection;
	}
	
	function makeImageTable(images) {
		var index = 0;
		var maxWidth = 4;
		tableHTML = "<table border='1' width='100%'>";
		var numberImages = images.length;
		switch(tableFormat) {
		case "grid":
			tableHTML+= "<tr>";
			for (var i=0; i < numberImages; i++) {
				tableHTML+= "<td align='center'>";
				if (images[index].pngFilename!=null) tableHTML+= "<a href='" + images[index].pngFilename + "'>"
				tableHTML+= "<img src='" + images[index].thumbnailFilename + "'>";
				tableHTML+= "<br/>" + images[index].sourceFilename;
				if (images[index].pngFilename!=null) tableHTML+= "</a>";
				tableHTML+= "</td>";
				index++;
				if ((index % maxWidth) == 0) tableHTML+= "</tr></tr>";
			}
			tableHTML+= "</tr>";
			break;
		case "rows":
			for (var i=0; i < numberImages; i++) {
				tableHTML+= "<tr><td>";
				if (images[index].pngFilename!=null) tableHTML+= "<a href='" + images[index].pngFilename + "'>";
				tableHTML+= "<img align='left' src='" + images[index].thumbnailFilename + "'>";
				if (images[index].pngFilename!=null) tableHTML+= "</a>";
				tableHTML+= "<br/>" + images[index].sourceFilename;
				tableHTML+= "</td></tr>";
				index++;
			}
			break;
		}

		tableHTML+= "</table>";
		$("#imagetable").html(tableHTML);
	}
	
	function switchTable(format) {
		if (format=="grid") {
			console.log("Grid table requested...");
			if (tableFormat=="grid") {
				console.log("...ignoring it.");
			} else {
				tableFormat = "grid";
				makeImageTable(currentImages);
			}
		}
		if (format=="rows") {
			console.log("Row table requested...");
			if (tableFormat=="rows") console.log("...ignoring it.");
			else {
				tableFormat = "rows";
				makeImageTable(currentImages);
			}
		}
		localStorage.tableFormat = tableFormat;	
	}
	
	function filterImages() {
		enteredText = document.getElementById("filter").value;
		console.log(enteredText);
		var filteredImages = [];
		for (var i in allImages) {
			if (allImages[i].sourceFilename.indexOf(enteredText)!=-1) filteredImages.push(allImages[i]);
		}
		console.log(filteredImages);
		currentImages = filteredImages;
		makeImageTable(filteredImages);
		$("#numberimages").text(currentImages.length + "/" + allImages.length);
		localStorage.searchString = enteredText;
	}
	
	
</script>
<body>	
	
	<h1>FITS image browser</h1>
	<p>Number of images: <strong><span id="numberimages">0</span></strong></p>
	<span class="glyphicon glyphicon-th" onclick="switchTable('grid')"></span>&nbsp;
	<span class="glyphicon glyphicon-th-list" onclick="switchTable('rows')"></span>&nbsp;
	<span id="sorticon" class="glyphicon glyphicon-sort-by-alphabet-alt" onclick="sort('toggle')"></span>&nbsp;
	<input type="text" size="8" id="filter" oninput="filterImages()"/><span class="glyphicon glyphicon-search" onclick="filter()"></span>
	<br/>
	<canvas id="imagecanvas" width="400" height="400" style="position: absolute; z-index: 1; left: 50px; top: 20px; background-color: grey; font-size: 14px; opacity: 1.0; visibility: hidden;">
		Fallback content, in case the browser does not support Canvas.
	</canvas>
	<span id="imagetable"></span>
</body>

</html>
